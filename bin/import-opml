#!/usr/bin/env python
import sys,os,time,datetime,feedparser,urllib2
from django.utils.timezone import utc
from django.core.exceptions import ObjectDoesNotExist

import xml.etree.ElementTree as et

if os.path.isfile('reader2/settings.py'):
    sys.path.append(os.getcwd())
else:
    sys.exit('Error: not in the root directory of the django project.');

os.environ['DJANGO_SETTINGS_MODULE'] = 'reader2.settings'
from django.contrib.auth.models import User
from feeds.models import Category,Feed

try:
    inputfile = sys.argv[1]
    username = sys.argv[2]
except IndexError:
    sys.exit('USAGE: bin/import-opml inputfile username')

xml = et.parse(inputfile)
for categoryNode in xml.find('body').findall('outline'):
    categoryTitle = categoryNode.attrib['title']

    try:
        category = Category.objects.get(title=categoryTitle)
    except ObjectDoesNotExist:
        category = Category(title=categoryTitle)
        category.user = User.objects.get(username=username)
        category.save()

    for feedNode in categoryNode.findall('outline'):
        feedTitle = feedNode.attrib['title']
        print '    importing',feedTitle
        
        feed = Feed()
        feed.title = feedTitle
        feed.htmlUrl = feedNode.attrib['htmlUrl']
        feed.xmlUrl = feedNode.attrib['xmlUrl']
        feed.save()

        category.feeds.add(feed)
        category.save()
        