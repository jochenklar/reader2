#!/usr/bin/env python
import sys,os,time,datetime,feedparser,urllib2
from django.utils.timezone import utc
from django.core.exceptions import ObjectDoesNotExist

import xml.etree.ElementTree as et

if os.path.isfile('reader2/settings.py'):
    sys.path.append(os.getcwd())
else:
    sys.exit('Error: not in the root directory of the django project.');

os.environ['DJANGO_SETTINGS_MODULE'] = 'reader2.settings'
from feeds.models import Category,Feed

try:
    outputfile = sys.argv[1]
except IndexError:
    sys.exit('Error: no output file.')

# create root node

opml = et.Element('opml')
opml.set('version', '1.0')

head = et.SubElement(opml, 'head')
title = et.SubElement(head, 'title')
title.text = 'Subscriptions'

body = et.SubElement(opml, 'body')

for category in Category.objects.all():
    categoryNode = et.SubElement(body 'outline')
    categoryNode.set('title',category.title)
    categoryNode.set('text',category.title)

    for feed in category.feeds.all():
        feedNode = et.SubElement(categoryNode, 'outline')
        feedNode.set('title',feed.title)
        feedNode.set('text',feed.title)
        feedNode.set('type','rss')
        feedNode.set('xmlUrl',feed.xmlUrl)
        feedNode.set('htmlUrl',feed.htmlUrl)

open(outputfile,'w').write(et.tostring(opml))
